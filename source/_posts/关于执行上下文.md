---
title: 关于执行上下文
date: 2019-03-27 15:25:45
tags: JavaScript
categories: JavaScript基础
---

# 缘由

网上找了一些文章学习，想着以后不要忘记了，便总结了一些自己的理解。帮助比较大文章：

- [JavaScript 论代码执行上下文](<https://www.jianshu.com/p/8f19e45fd1f1>)
- [JavaScript深入之执行上下文](<https://github.com/mqyqingfeng/Blog/issues/8>)
- [JavaScript深入之作用域链](<https://github.com/mqyqingfeng/Blog/issues/6>)

# 执行上下文

当JavaScript在执行代码时，会产生不同的执行上下文，若干的执行上下文会构成执行上下文栈，就相当于一个人在处理事情，在处理过程中引发了其他事情，发现只有解决引发的事情后，才能继续之前的任务。以此类推，以便理解栈中的先进后出，后进先出的说法。

![进栈出栈的过程](ecs.png)

# 执行过程

在执行过程中，有两种执行环境需要分析：

1. 全局执行环境
2. 函数执行环境

以代码为例：

```js
var globalVar = 1;
function globalFunction(num){
    var localVar = 2;
    return localVar + num + globalVar;
}
globalFunction(3);
```

## 全局执行环境

1. 执行全局代码，创建全局执行上下文，全局上下文被压入执行上下文栈。
   ![全局上下文压栈](globalContext.png)

2. 全局上下文初始化

   ```js
   globalContext = {
       VO: {
          globalVar: undefined,
          globalFunction: 函数地址
       },
       Scope: [globalContext.VO],
       this: globalContext.VO
   }
   ```

   globalFunction函数被创建的同时，保存作用域链到函数的内部属性[[scope]]

   ```js
   globalFunction.[[scope]] = [globalContext.VO]
   ```

3. 执行全局代码，从上到下依次执行

   ```js
   globalContext = {
       VO: {
          globalVar: 1,
          globalFunction: 函数地址
       },
       Scope: [globalContext.VO],
       this: globalContext.VO
   }
   ```

4. 当执行到调用函数时，创建函数执行上下文

## 函数执行环境

1. 函数执行上下文被压入执行上下文栈的顶部
   ![函数上下文压栈](globalFunctionContext.png)

2. 函数上下文初始化

   > 1. 创建活动对象，初始化活动对象，即加入变量声明、函数声明、形参
   > 2. 复制函数 [[scope]] 属性创建作用域链
   > 3. 将活动对象压入函数作用域链顶端

   ```js
     globalFunctionContext = {
         AO: {
             num:3,
             localVar: undefined,
             arguments: {
                 0: 3,
                 length: 1
             },
         },
         Scope: [AO, globalContext.VO],
         this: undefined
     }
   ```

3. 执行函数代码，从上到下依次执行
   1. 第一句，修改 AO 的属性值

       ```js
       var localVar = 2;
       ```

       ```js
       globalFunctionContext = {
            AO: {
                num:3,
                localVar: 2,
                arguments: {
                    0: 3,
                    length: 1
                },
            },
            Scope: [AO, globalContext.VO],
            this: undefined
        }
       ```

   2. 第二句

       ```js
       return localVar + num + globalVar;
       ```

       依次在globalFunctionContext的作用域链Scope中寻找查找，最终输出数值

4. 最后，函数执行完毕，函数执行上下文从执行上下文栈中弹出
   ![函数上下文出栈](pull.png)

------

活动对象：函数执行上下文中，VO是不能直接访问的，此时由活动对象AO扮演VO的角色。

